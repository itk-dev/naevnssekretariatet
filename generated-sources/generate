#!/usr/bin/env bash
set -o errtrace -o noclobber -o nounset -o pipefail
IFS=$'\n\t'

script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
bold=$(tput bold)
normal=$(tput sgr0)

cd "$script_dir" || exit

service_name=sf1600
service_doc_url=https://docs.kombit.dk/integration/sf1600/2.5/pakke

echo "${bold}Fetching $service_doc_url.${normal}"
curl --location --silent $service_doc_url/pakke --output /tmp/$service_name.zip

echo "${bold}Extracting files.${normal}"
# Hide an error:
#   error:  cannot create SF1600 - Print p+ï¿½ Serviceplatformen v.2.5.pdf
#           Illegal byte sequence
(cd /tmp && unzip -qq -o /tmp/$service_name.zip > /dev/null 2>&1)
mkdir -p $service_name
(cd $service_name && unzip -qq -o /tmp/SF1600\ Teknisk\ Spec*.zip)

echo "${bold}Generating PHP classes.${normal}"
rm -fr serviceplatformen/$service_name
# @see https://github.com/WsdlToPhp/PackageGenerator/wiki/Options
docker run --rm -it --volume "$PWD":/app --workdir /app mikaelcom/wsdltophp generate:package \
       --standalone=false \
       --quiet \
       --urlorpath=./$service_name/wsdl/token/PrintService.wsdl \
       --destination=serviceplatformen/$service_name \
       --namespace='ItkDev\Serviceplatformen\SF1600' \
       --force

rm -fr $service_name

echo "${bold}Done.${normal}"
