on: pull_request
name: Build Release
jobs:
  build-package:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: true
      matrix:
        php: ['7.4']
        node: ['14']
    name: Build package
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup PHP, with composer and extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: apcu, ctype, iconv, imagick, json, redis, soap, xmlreader, zip
          coverage: none

      - name: Validate composer files
        run: composer validate composer.json

      - name: Composer install with exported .env variables
        run: |
          set -a && source .env && set +a
          APP_ENV=prod composer install --no-dev -o

      - name: Setup node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}

      - name: Yarn build
        run: |
          yarn install
          yarn run encore production

#      - name: Package tar
#        run: |
#          mkdir -p ./build
#          tar \
#            --exclude ='./.git' \
#            --exclude ='./build' \
#            --exclude='./node_modules' \
#            --exclude='./var/cache/dev' \
#            -zcvf ./build/TVIST1-$GITHUB_SHA.tar.gz .
#          ls -la ./build

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
